# ============================================================
# tmux 推薦設定檔
# ============================================================
# 路徑：~/.tmux.conf 或 ~/.config/tmux/tmux.conf
# 套用方式：tmux source-file ~/.tmux.conf
# ============================================================

# ────────────────────────────────────────────────────────────
# 一般設定
# ────────────────────────────────────────────────────────────

# True Color 支援（搭配現代終端模擬器）
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc,alacritty:Tc,wezterm:Tc"

# 啟用滑鼠支援（可用滑鼠切換面板、調整大小、捲動）
set -g mouse on

# Window / Pane 編號從 1 開始（0 在鍵盤上太遠）
set -g base-index 1
setw -g pane-base-index 1

# 消除 Esc 鍵延遲（對 vim/neovim 使用者極為重要）
set -sg escape-time 0

# 捲動歷史行數
set -g history-limit 50000

# 關閉 Window 後自動重新編號
set -g renumber-windows on

# 啟用系統剪貼簿整合
set -g set-clipboard on

# 允許終端程式設定視窗標題
set -g set-titles on
set -g set-titles-string "#S - #W"

# 狀態列訊息顯示時間（毫秒）
set -g display-time 3000

# 面板切換提示顯示時間（毫秒）
set -g display-panes-time 2000

# 監控其他 Window 的活動
setw -g monitor-activity on
set -g visual-activity off

# ────────────────────────────────────────────────────────────
# Prefix 鍵
# ────────────────────────────────────────────────────────────

# 改為 Ctrl+A（比預設的 Ctrl+B 更順手，源自 GNU Screen 傳統）
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# ────────────────────────────────────────────────────────────
# Pane 操作
# ────────────────────────────────────────────────────────────

# 直覺式分割鍵（| 水平分割、- 垂直分割，保留當前路徑）
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# 保留預設分割鍵（% 和 "）但也加上路徑保持
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Vim 風格面板導航（prefix + h/j/k/l）
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim 風格面板大小調整（prefix + H/J/K/L，-r 允許連續按）
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 面板全螢幕切換（prefix + z，預設即有，此處明確列出）
# bind z resize-pane -Z

# 面板交換位置
bind > swap-pane -D
bind < swap-pane -U

# ────────────────────────────────────────────────────────────
# Window 操作
# ────────────────────────────────────────────────────────────

# 新建 Window（保留當前路徑）
bind c new-window -c "#{pane_current_path}"

# 快速切換 Window（-r 允許連續按）
bind -r [ previous-window
bind -r ] next-window

# 移動 Window 位置
bind -r S-Left swap-window -t -1\; select-window -t -1
bind -r S-Right swap-window -t +1\; select-window -t +1

# 快速切換到上一個 Window
bind Space last-window

# ────────────────────────────────────────────────────────────
# Copy Mode（Vi 模式）
# ────────────────────────────────────────────────────────────

# 使用 vi 按鍵綁定
setw -g mode-keys vi

# 進入 copy mode
bind v copy-mode

# Vi 風格選取與複製
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# 滑鼠拖曳選取後不自動離開 copy mode
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection -x

# 系統剪貼簿整合（依平台自動選擇）
# macOS
if-shell "uname | grep -q Darwin" \
    "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'pbcopy'"

# Linux（X11）
if-shell "command -v xclip > /dev/null && [ -n \"$DISPLAY\" ]" \
    "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -selection clipboard'"

# Linux（Wayland）
if-shell "command -v wl-copy > /dev/null && [ -n \"$WAYLAND_DISPLAY\" ]" \
    "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'wl-copy'"

# ────────────────────────────────────────────────────────────
# 狀態列（Catppuccin Mocha 配色）
# ────────────────────────────────────────────────────────────

# 狀態列位置
set -g status-position bottom

# 更新間隔（秒）
set -g status-interval 5

# 狀態列長度
set -g status-left-length 40
set -g status-right-length 60

# Catppuccin Mocha 色彩定義
# Base: #1e1e2e | Mantle: #181825 | Surface0: #313244
# Blue: #89b4fa | Green: #a6e3a1 | Lavender: #b4befe
# Text: #cdd6f4 | Subtext0: #a6adc8 | Overlay0: #6c7086

# 狀態列背景
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# 左側：Session 名稱
set -g status-left "#[bg=#89b4fa,fg=#1e1e2e,bold] #S #[bg=#1e1e2e] "

# 右側：日期與時間
set -g status-right "#[fg=#a6adc8] %Y-%m-%d #[fg=#89b4fa]%H:%M "

# Window 列表樣式
set -g window-status-format "#[fg=#6c7086] #I:#W "
set -g window-status-current-format "#[bg=#313244,fg=#89b4fa,bold] #I:#W "

# Window 列表對齊方式（置中）
set -g status-justify centre

# ────────────────────────────────────────────────────────────
# 外觀設定
# ────────────────────────────────────────────────────────────

# 面板邊框顏色
set -g pane-border-style "fg=#313244"
set -g pane-active-border-style "fg=#89b4fa"

# 訊息列樣式
set -g message-style "bg=#313244,fg=#cdd6f4"

# Copy mode 高亮樣式
set -g mode-style "bg=#313244,fg=#cdd6f4"

# ────────────────────────────────────────────────────────────
# 彈出式快捷鍵速查表（tmux 3.2+）
# ────────────────────────────────────────────────────────────

# prefix + ? 顯示互動式速查表（覆寫預設的 list-keys）
unbind ?
bind ? display-popup -w 58 -h 30 -E "\
    echo '' && \
    echo '   tmux 快捷鍵速查表 (prefix = Ctrl+A)' && \
    echo '   ─────────────────────────────────────' && \
    echo '' && \
    echo '   Session' && \
    echo '     d   Detach        s   列出 Session' && \
    echo '     \$   重新命名     (/) 上/下一個 Session' && \
    echo '' && \
    echo '   Window' && \
    echo '     c   新建          ,     重新命名' && \
    echo '     [/] 上/下一個     Space 上一個 Window' && \
    echo '     1-9 切換到編號    &     關閉' && \
    echo '' && \
    echo '   Pane' && \
    echo '     |       水平分割      -       垂直分割' && \
    echo '     h/j/k/l 方向導航      H/J/K/L 調整大小' && \
    echo '     z       全螢幕切換    x       關閉' && \
    echo '     >/<     交換位置      q       顯示編號' && \
    echo '' && \
    echo '   Copy Mode (prefix+v 進入)' && \
    echo '     v   開始選取      y   複製並離開' && \
    echo '     /   搜尋          n/N 下/上一個結果' && \
    echo '' && \
    echo '   其他' && \
    echo '     :   命令提示字元  ?   本速查表' && \
    echo '     r   重新載入設定  I   安裝 Plugin' && \
    echo '' && \
    echo '   按 Enter 或 q 關閉' && \
    read -n 1"

# ────────────────────────────────────────────────────────────
# 快捷操作
# ────────────────────────────────────────────────────────────

# 重新載入設定檔
bind r source-file ~/.tmux.conf \; display-message "設定已重新載入"

# ────────────────────────────────────────────────────────────
# TPM（Tmux Plugin Manager）
# ────────────────────────────────────────────────────────────
# 安裝：git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# 安裝 plugin：prefix + I
# 更新 plugin：prefix + U
# 移除 plugin：prefix + Alt+u

# 合理預設值（減少手動設定）
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Session 持久化（系統重啟後可恢復 Session）
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# 自動儲存間隔（分鐘）
set -g @continuum-save-interval '15'

# 系統剪貼簿整合（補強跨平台複製）
set -g @plugin 'tmux-plugins/tmux-yank'

# ────────────────────────────────────────────────────────────
# 初始化 TPM（此行必須在設定檔最底部）
# ────────────────────────────────────────────────────────────
run '~/.tmux/plugins/tpm/tpm'
